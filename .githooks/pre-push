#!/usr/bin/env bash
set -euo pipefail

if [[ "${SKIP_GIT_CHECKS:-0}" == "1" || "${SKIP_PREPUSH_TESTS:-0}" == "1" ]]; then
  echo "‚ö†Ô∏è  Pre-Push-Checks √ºbersprungen (SKIP_GIT_CHECKS/SKIP_PREPUSH_TESTS gesetzt)."
  exit 0
fi

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

echo "üîé Pre-Push: schnelle Checks starten ..."

# Gegen welchen Stand vergleichen wir?
if git rev-parse --verify --quiet origin/main >/dev/null; then
  diff_range="origin/main...HEAD"
else
  diff_range="HEAD"
fi

# Backend: Ruff nur auf ge√§nderten Python-Dateien unter backend/src
if [[ -d backend ]]; then
  mapfile -t backend_py_files < <(git diff --name-only --diff-filter=ACMRT "$diff_range" -- "backend/src/*.py" "backend/src/**/*.py")
  if [[ ${#backend_py_files[@]} -gt 0 ]]; then
    echo "‚Ä¢ Ruff auf ${#backend_py_files[@]} ge√§nderten Backend-Datei(en)"
    if command -v /mnt/data/pdms-v6/.venv/bin/python >/dev/null 2>&1; then
      /mnt/data/pdms-v6/.venv/bin/python -m ruff check "${backend_py_files[@]}"
    else
      python -m ruff check "${backend_py_files[@]}"
    fi
  else
    echo "‚Ä¢ Keine ge√§nderten Backend-Python-Dateien gefunden ‚Äî Ruff √ºbersprungen"
  fi
fi

# Frontend: ESLint nur auf ge√§nderten JS/TS-Dateien
if [[ -d frontend ]] && command -v pnpm >/dev/null 2>&1; then
  mapfile -t frontend_files < <(git diff --name-only --diff-filter=ACMRT "$diff_range" -- "frontend/src/*.js" "frontend/src/**/*.js" "frontend/src/*.jsx" "frontend/src/**/*.jsx" "frontend/src/*.ts" "frontend/src/**/*.ts" "frontend/src/*.tsx" "frontend/src/**/*.tsx")
  if [[ ${#frontend_files[@]} -gt 0 ]]; then
    echo "‚Ä¢ ESLint auf ${#frontend_files[@]} ge√§nderten Frontend-Datei(en)"
    (
      cd frontend
      pnpm exec eslint "${frontend_files[@]/#frontend\//}"
    )
  else
    echo "‚Ä¢ Keine ge√§nderten Frontend-Dateien gefunden ‚Äî ESLint √ºbersprungen"
  fi
fi

echo "‚úÖ Pre-Push-Checks erfolgreich."
exit 0