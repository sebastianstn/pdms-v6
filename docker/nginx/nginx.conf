# ─────────────────────────────────────────────────────────────────
# PDMS Home-Spital — Nginx Reverse Proxy mit SSL/TLS
# Unterstützt:
#   - TLS 1.2 + 1.3 mit starken Cipher-Suites
#   - HTTP → HTTPS Redirect
#   - HSTS, CSP, X-Frame-Options, X-Content-Type-Options
#   - OCSP Stapling (nur mit CA-signierten Zertifikaten)
#   - Let's Encrypt ACME Challenge
#   - WebSocket-Proxy (Vitals + Alarms)
#   - Perfect Forward Secrecy (DH-Parameter)
# ─────────────────────────────────────────────────────────────────

events {
  worker_connections 1024;
}

http {
  resolver 127.0.0.11 valid=30s ipv6=off;

  # ── Rate-Limiting Zones (OWASP / IEC 62304) ─────────────────────
  # API: 30 Requests/Sekunde pro Client-IP
  limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
  # Auth: 5 Requests/Sekunde (Brute-Force-Schutz)
  limit_req_zone $binary_remote_addr zone=auth:5m rate=5r/s;
  # WebSocket: 10 Connections/Sekunde
  limit_req_zone $binary_remote_addr zone=ws:5m rate=10r/s;
  # Global: 60 Requests/Sekunde
  limit_req_zone $binary_remote_addr zone=global:10m rate=60r/s;
  # Rate-Limit-Response: 429 Too Many Requests
  limit_req_status 429;

  # ── Upstreams ──────────────────────────────────────────────────
  upstream web  { server web:3000; }
  upstream api  { server api:8000; }
  upstream auth { server keycloak:8080; }

  # ── Logging ────────────────────────────────────────────────────
  log_format pdms '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent '
                  '"$http_referer" "$http_user_agent" '
                  'rt=$request_time ssl=$ssl_protocol';

  access_log /var/log/nginx/access.log pdms;
  error_log  /var/log/nginx/error.log warn;

  # ── Performance ────────────────────────────────────────────────
  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout 65;
  types_hash_max_size 2048;
  client_max_body_size 10m;

  # ── Gzip ───────────────────────────────────────────────────────
  gzip on;
  gzip_vary on;
  gzip_min_length 256;
  gzip_types text/plain text/css application/json application/javascript
             text/xml application/xml text/javascript image/svg+xml;

  # ── SSL-Defaults (gemeinsam für alle server-Blöcke) ────────────
  ssl_certificate     /etc/nginx/ssl/pdms.crt;
  ssl_certificate_key /etc/nginx/ssl/pdms.key;
  ssl_dhparam         /etc/nginx/ssl/dhparam.pem;

  # TLS 1.2 + 1.3 — kein TLS 1.0/1.1 (IEC 62304, nDSG)
  ssl_protocols TLSv1.2 TLSv1.3;

  # Starke Cipher-Suites — AEAD bevorzugt, kein CBC, kein RC4
  ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305';
  ssl_prefer_server_ciphers on;

  # SSL-Session-Cache (reduziert Handshake-Overhead)
  ssl_session_cache   shared:SSL:10m;
  ssl_session_timeout 1d;
  ssl_session_tickets off;

  # OCSP Stapling (nur mit CA-signierten Zertifikaten aktiv)
  # ssl_stapling on;
  # ssl_stapling_verify on;
  # ssl_trusted_certificate /etc/nginx/ssl/chain.pem;

  # ═══════════════════════════════════════════════════════════════
  # Server-Block 1: HTTP → HTTPS Redirect + ACME Challenge
  # ═══════════════════════════════════════════════════════════════
  server {
    listen 80;
    server_name _;

    # Health Check (auch über HTTP erreichbar für Docker-Healthcheck)
    location /health {
      access_log off;
      return 200 'ok';
      add_header Content-Type text/plain;
    }

    # Let's Encrypt ACME Challenge
    location /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    # Alles andere → HTTPS
    location / {
      return 301 https://$host$request_uri;
    }
  }

  # ═══════════════════════════════════════════════════════════════
  # Server-Block 2: HTTPS — Hauptkonfiguration
  # ═══════════════════════════════════════════════════════════════
  server {
    listen 443 ssl;
    http2 on;
    server_name _;

    # ── Security Headers (IEC 62304 / nDSG / OWASP) ─────────────
    # HSTS — Browser erzwingt HTTPS für 1 Jahr
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Clickjacking-Schutz
    add_header X-Frame-Options "SAMEORIGIN" always;

    # MIME-Sniffing verhindern
    add_header X-Content-Type-Options "nosniff" always;

    # XSS-Filter (Legacy-Browser)
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer-Policy — nur Origin bei Cross-Origin
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content-Security-Policy — streng aber funktional
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' wss: ws:; frame-src 'self'; base-uri 'self'; form-action 'self';" always;

    # Permissions-Policy — minimale Browser-APIs
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()" always;

    # ── Health Check ─────────────────────────────────────────────
    location /health {
      access_log off;
      return 200 'ok';
      add_header Content-Type text/plain;
    }

    # ── Frontend (Next.js) ───────────────────────────────────────
    location / {
      proxy_pass http://web;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }

    # ── API (FastAPI) ────────────────────────────────────────────
    location /api/ {
      limit_req zone=api burst=40 nodelay;
      proxy_pass http://api;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # ── WebSocket (Vitals + Alarms) ──────────────────────────────
    location /ws/ {
      limit_req zone=ws burst=5;
      proxy_pass http://api;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_read_timeout 86400;
    }

    # ── Keycloak (Auth) ──────────────────────────────────────────
    location /auth/ {
      limit_req zone=auth burst=10 nodelay;
      proxy_pass http://auth/;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # ── AI Orchestrator (optional) ───────────────────────────────
    location /ai/ {
      set $ai_upstream http://ai-orchestrator:8081;
      proxy_pass $ai_upstream$request_uri;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      proxy_read_timeout 120;
    }

    # ── Statische Dateien (Cache-Header) ─────────────────────────
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?|ttf|eot)$ {
      proxy_pass http://web;
      proxy_set_header Host $host;
      expires 7d;
      add_header Cache-Control "public, immutable";
      access_log off;
    }
  }
}
